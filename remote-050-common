opkg_install $config_packages

uci batch <<EOF
set system.@system[0].timezone='CST-8'
set system.@system[0].zonename='Asia/Shanghai'
EOF
uci_batch_set "$config_common"
service reload system

uci set system.@system[0].log_buffer_size='256'
service reload log system

uci_delete system.ntp.server
uci_add_list system.ntp.server 0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org
service restart sysntpd system

uci set dhcp.@dnsmasq[0].cachesize=1024
uci_add_list dhcp.@dnsmasq[0].bogusnxdomain 122.229.30.202 60.191.124.236

uci_del_type dhcp host
dhcp_host() {
    local ip mac
    while read ip mac
    do
        uci add dhcp host >/dev/null
        uci set "dhcp.@host[-1].ip=${ip}"
        uci set "dhcp.@host[-1].mac=${mac}"
    done
}
echo "$config_dhcp_host" | strip_comment | dhcp_host

service reload dnsmasq dhcp

if [ -f /etc/dropbear/authorized_keys ]; then
    uci batch <<EOF
set dropbear.@dropbear[0].PasswordAuth='off'
set dropbear.@dropbear[0].RootPasswordAuth='off'
EOF
    service reload dropbear
fi

service stop telnetd
service disable telnetd
