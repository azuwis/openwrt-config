#!/bin/sh
set -eu

opkg_update() {
    if [ "$(find /var/opkg-lists/ -type f | wc -l)" -eq 0 ]; then
        echo 'opkg update'
        opkg update
    fi
}

opkg_installed() {
    opkg status "$1" | grep -q installed
}

opkg_install() {
    opkg_update
    for package in "$@"
    do
        if ! opkg_installed "$package"; then
            echo "install package $package"
            opkg install "$package"
        fi
    done
}

opkg_install_url() {
    ipk_url="$1"
    ipk_img="$(basename "$ipk_url")"
    ipk_name=$(basename "$ipk_url" | awk -F_ '{print $1}')
    if ! opkg_installed "$ipk_name"; then
        cd /tmp/
        wget "$ipk_url"
        echo "install package $ipk_name"
        opkg install "$ipk_img"
    fi
}

uci_add_list() {
    key="$1"
    shift
    for value in "$@"
    do
        if ! printf "$(uci -q -d '\n' get "$key")" | grep -qxF "$value"; then
            uci add_list "$key=$value"
        fi
    done
}

uci_commit() {
    config="$1"
    if ! uci -q get "$config" >/dev/null; then
        return
    fi
    if [ x"$(md5sum_config "$config")" != x"$(md5sum_uci "$config")" ]; then
        echo "uci commit"
        uci changes "$config"
        uci commit
    else
        rm -f "/var/.uci/$config"
    fi
}

uci_delete() {
    for config in "$@"
    do
        if uci -q get "$config" >/dev/null; then
            uci delete "$config"
        fi
    done
}

uci_del_type() {
    config="$1"
    type="$2"
    deleted="0"
    while uci -q delete "${config}.@${type}[-1]"
    do
        deleted=$((deleted+1))
    done
}

service_enable() {
    for service in "$@"
    do
        echo "enable/restart service $service"
        "/etc/init.d/$service" enable
        "/etc/init.d/$service" restart
    done
}

service() {
    action="$1"
    service="$2"
    config="${3:-$service}"
    case "$action" in
        reload|restart)
            if ! uci -q get "$config" >/dev/null; then
                return
            fi
            if [ x"$(md5sum_config "$config")" != x"$(md5sum_uci "$config")" ]; then
                echo "service $action $service"
                "/etc/init.d/$service" "$action"
            fi
            ;;
        *)
            echo "service $action $service"
            "/etc/init.d/$service" "$action"
            ;;
    esac
}

hr() {
    printf '%s\n' ------------------------------------------------------------
}

md5sums="$(cd /etc/config; md5sum *)"

md5sum_config() {
    config="$1"
    echo "$md5sums" | grep -F " $config" | cut -d' ' -f1
}

md5sum_uci() {
    config="$1"
    uci export "$config" | grep -v '^package '| md5sum | cut -d' ' -f1
}
