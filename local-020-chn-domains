chn_domains() {
    sed -e 's!^server=/!!' -e 's!/114.114.114.114$!!' | grep -Fv cn.debian.org
}

if [ ! -e files/chn-domains ]; then
    if [ ! -e files/accelerated-domains.china.conf ]; then
        download https://github.com/felixonmars/dnsmasq-china-list/raw/master/accelerated-domains.china.conf
    fi
    chn_domains < files/accelerated-domains.china.conf > files/chn-domains
fi

if [ ! -e files/chn-domains.gz -o files/chn-domains -nt files/chn-domains.gz ]; then
    echo 'zipping files/chn-domains'
    gzip -f -k -n files/chn-domains
fi

push files/chn-domains.gz /etc/chn-domains.gz
push files/chn-domains-extra /etc/chn-domains-extra
push files/99-chn-domains /etc/hotplug.d/iface/99-chn-domains

push files/chn-domains.keep /lib/upgrade/keep.d/chn-domains
