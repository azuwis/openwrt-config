opkg_install /tmp/shadowsocks-libev-spec.ipk
uci set shadowsocks.@access_control[0].wan_bp_list='/etc/chinadns_chnroute.txt'
uci_batch_set "$config_shadowsocks"
service restart shadowsocks

opkg_install unbound
cat >/tmp/unbound.conf <<EOF
server:
    username: "nobody"
    pidfile: "/var/run/unbound.pid"

    port: 5354
    cache-min-ttl: 900
    # prefetch: yes
    tcp-upstream: ${config_unbound_tcp}

    num-threads: 1
    outgoing-num-tcp: 1
    incoming-num-tcp: 1
    outgoing-range: 60
    num-queries-per-thread: 30

    msg-buffer-size: 8192
    msg-cache-size: 100k
    msg-cache-slabs: 1
    rrset-cache-size: 100k
    rrset-cache-slabs: 1
    infra-cache-slabs: 1
    infra-cache-numhosts: 200
    key-cache-size: 100k
    key-cache-slabs: 1
    neg-cache-size: 10k

    target-fetch-policy: "2 1 0 0 0 0"
    harden-short-bufsize: yes
    harden-large-queries: yes

forward-zone:
    name: "."
    forward-addr: ${config_unbound_forwarder}
EOF
if move /tmp/unbound.conf /etc/unbound/unbound.conf; then
    service restart unbound -
fi

opkg_install /tmp/ChinaDNS.ipk
move /tmp/chinadns_chnroute.txt /etc/chinadns_chnroute.txt || true
if ! grep -qF 'mkdir -p /tmp/dnsmasq.d' /etc/init.d/chinadns; then
    echo 'patch /etc/init.d/chinadns start()'
    sed -i -e '/start_chinadns chinadns/a mkdir -p /tmp/dnsmasq.d; echo -e "no-resolv\\nserver=127.0.0.1#5353" >/tmp/dnsmasq.d/10-chinadns.conf; /etc/init.d/dnsmasq restart' /etc/init.d/chinadns
fi
if ! grep -qF 'rm -f /tmp/dnsmasq.d/10-chinadns.conf' /etc/init.d/chinadns; then
    echo 'patch /etc/init.d/chinadns stop()'
    sed -i -e '/service_stop \/usr\/bin\/chinadns/a rm -f /tmp/dnsmasq.d/10-chinadns.conf; /etc/init.d/dnsmasq restart' /etc/init.d/chinadns
fi
local_dns="$(awk '/^# Interface wan$/ {getline; print $2}' /var/resolv.conf.auto)"
uci set chinadns.@chinadns[0].server="${local_dns},127.0.0.1#5354"
service restart chinadns
