if echo "$config_network6" | grep -qxF 'network.wan6.proto=6to4'; then
    opkg_install 6to4
fi

uci_delete network.globals.ula_prefix network.wan6 network.henet
uci batch <<EOF
set network.wan6='interface'
set network.wan6.proto='none'
set network.wan6.metric='50'
EOF
uci_batch_set "$config_network6"

if echo "$config_henet" | grep -q '^network\.henet'; then
    opkg_install 6in4
    if ! grep -q 'local max=8$' /lib/netifd/proto/6in4.sh; then
        echo 'patch /lib/netifd/proto/6in4.sh'
        sed -i -e 's/local max=.*$/local max=8/' /lib/netifd/proto/6in4.sh
    fi
    uci batch <<EOF
set network.henet='interface'
set network.henet.proto='6in4'
set network.henet.metric='30'
EOF
    uci_batch_set "$config_henet"

    uci_add_list firewall.@zone[1].network henet
    service reload firewall
fi

service reload network 2>/dev/null
