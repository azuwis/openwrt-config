#!/bin/bash

DEBUG=''
GEN_ONLY='no'

target="$1"
shift

while getopts ":xg" Option
do
    case "$Option" in
        x) DEBUG='-x' ;;
        g) GEN_ONLY='yes' ;;
    esac
done

source "$target"
port="${port:-22}"

if [ -f "${target}.gpg" ]; then
    source <(gpg --batch --no-tty -qd "${target}.gpg")
fi

backup() {
    ssh "$host" 'sysupgrade --create-backup -' | tar zxf -
}

push() {
    file="$1"
    scp -p "$file" "${host}:/${file}"
}

generate_script() {
    cat functions
    for module in $modules
    do
        cat <<EOF
echo "Begin $module"
EOF
        if [ -x "$module" ]; then
            "./$module"
        else
            envsubst < "$module"
        fi
        cat <<EOF
echo "End $module"
hr
EOF
    done
}

if [ "$GEN_ONLY" = 'yes' ]; then
    generate_script
    exit
fi

generate_script | ssh -p "$port" "$host" 's=/tmp/openwrt-config; cat > $s; sh '$DEBUG' $s; rm $s'
